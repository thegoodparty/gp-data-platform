version: 2

models:
  - name: users
    description: >
      Goodparty.org application users, with aggregate campaign counts appended.

      Grain: One row per user.

      Limitations: Win/loss outcome data requires future work and is not included in this MVP.

    columns:
      - name: user_id
        description: Primary key - unique user identifier from gp-api production database
        data_tests:
          - unique
          - not_null

      - name: email
        description: User's email address (primary contact, unique identifier)

      - name: first_name
        description: User's first name

      - name: last_name
        description: User's last name

      - name: phone
        description: User's phone number

      - name: zip
        description: User's zip code

      - name: created_at
        description: Timestamp when user account was created (signup date)

      - name: updated_at
        description: Timestamp when user account was last updated

      - name: campaign_count
        description: Total number of campaigns created by this user

      - name: non_demo_campaign_count
        description: Number of non-demo campaigns (use for production counts)

      - name: verified_campaign_count
        description: Number of verified campaigns

      - name: active_campaign_count
        description: Number of active campaigns

      - name: pro_campaign_count
        description: Number of pro-tier campaigns

      - name: pledged_campaign_count
        description: Number of campaigns where candidate took the GoodParty pledge

      - name: first_campaign_created_at
        description: Timestamp of user's first campaign creation

      - name: last_campaign_created_at
        description: Timestamp of user's most recent campaign creation

      - name: has_campaign
        description: Whether user has created at least one campaign
        data_tests:
          - not_null

      - name: has_verified_campaign
        description: Whether user has at least one verified campaign
        data_tests:
          - not_null

      - name: has_pledged_campaign
        description: Whether user has at least one pledged campaign
        data_tests:
          - not_null

      - name: is_serve_user
        description: >
          Whether the user is a "Serve" user. A user is considered a Serve user
          if they have created a poll through an elected office and the poll has
          been completed (is_completed = true).  This approximates a user
          creating a poll and viewing their results, which is the current
          definition for Serve platform usage. Note: Whether users actually
          viewed their results is tracked in Amplitude, not in the product
          database, so this flag uses poll completion as a proxy for viewing
          results.
        data_tests:
          - not_null

  - name: campaigns
    description: >
      Goodparty.org application campaigns.

      One row per campaign with user information denormalized.

      Grain: One row per campaign.

      Limitations: Win/loss outcome data requires future work and is not included in this MVP.

    columns:
      - name: campaign_id
        description: Primary key - unique campaign identifier from gp-api production database
        data_tests:
          - unique
          - not_null

      - name: campaign_slug
        description: URL-friendly campaign identifier used in app URLs

      - name: user_id
        description: Foreign key to user table - the user who owns this campaign
        data_tests:
          - not_null

      - name: user_email
        description: User's email address (primary contact)

      - name: user_first_name
        description: User's first name

      - name: user_last_name
        description: User's last name

      - name: user_phone
        description: User's phone number

      - name: user_zip
        description: User's zip code

      - name: user_created_at
        description: Timestamp when user account was created (signup date)

      - name: created_at
        description: Timestamp when this campaign was created

      - name: updated_at
        description: Timestamp when this campaign was last updated

      - name: is_verified
        description: Whether the campaign has been verified by GoodParty staff
        data_tests:
          - not_null

      - name: is_active
        description: Whether the campaign is currently active

      - name: is_pro
        description: Whether the campaign is on pro tier

      - name: is_demo
        description: Whether the campaign is a demo/test account (exclude from production counts)

      - name: is_pledged
        description: Whether the candidate has taken the GoodParty pledge

      - name: election_date
        description: Date of the election the campaign is targeting

      - name: campaign_state
        description: U.S. state where the campaign is running

      - name: campaign_office
        description: Political office the candidate is running for

      - name: campaign_party
        description: Political party affiliation

      - name: election_level
        description: Level of election (local, state, federal)

  - name: candidacy
    description: >
      Historical archive of candidacies from the general mart with elections on or before 2025-12-31.

      Grain: One row per candidacy.

    columns:
      - name: gp_candidacy_id
        description: Primary key - internally generated unique identifier for candidacies
        data_tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$

      - name: gp_candidate_id
        description: Foreign key to candidate table
        data_tests:
          - relationships:
              arguments:
                to: ref('candidate')
                field: gp_candidate_id
              config:
                where: "gp_candidate_id is not null"

      - name: gp_election_id
        description: Foreign key to election table

      - name: product_campaign_id
        description: Campaign ID from the GoodParty product database

      - name: hubspot_contact_id
        description: Contact ID from HubSpot CRM

      - name: candidate_id_source
        description: Source system for the candidate data (BallotReady, Techspeed, Product, etc.)

      - name: party_affiliation
        description: Candidate's political party

      - name: is_incumbent
        description: Whether the candidate is the incumbent

      - name: is_open_seat
        description: Whether the race is for an open seat

      - name: candidate_office
        description: Simplified/standardized office name

      - name: official_office_name
        description: Formal office title the candidate is running for

      - name: office_level
        description: Level of office (local, state, federal)

      - name: candidacy_result
        description: Result of the candidacy (won, lost, etc.)

      - name: pledge_status
        description: Status of the candidate's GoodParty pledge

      - name: verified_candidate
        description: Whether the candidate has been verified

      - name: is_partisan
        description: Whether the race is partisan

      - name: primary_election_date
        description: Date of the primary election

      - name: general_election_date
        description: Date of the general election
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: "'1900-01-01'"
                max_value: "'2025-12-31'"
              config:
                warn_if: ">0"
                error_if: ">10"

      - name: runoff_election_date
        description: Date of the runoff election, if applicable

      - name: viability_score
        description: Model-generated viability rating

      - name: win_number
        description: Estimated votes needed to win

      - name: win_number_model
        description: Model version used for win number calculation

      - name: created_at
        description: Timestamp when the record was created
        data_tests:
          - not_null

      - name: updated_at
        description: Timestamp when the record was last updated
        data_tests:
          - not_null

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "updated_at >= created_at"
          config:
            where: "updated_at is not null and created_at is not null"

  - name: candidate
    description: >
      Historical archive of candidates from the general mart with elections on or before 2025-12-31.

      Grain: One row per candidate.

    columns:
      - name: gp_candidate_id
        description: Primary key - internally generated unique identifier for candidates
        data_tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$

      - name: hubspot_contact_id
        description: Contact ID from HubSpot CRM
        data_tests:
          - not_null

      - name: prod_db_user_id
        description: User ID from the GoodParty production database

      - name: candidate_id_tier
        description: Internal confidence/priority tier for the candidate

      - name: first_name
        description: Candidate's first name

      - name: last_name
        description: Candidate's last name

      - name: full_name
        description: Candidate's full name

      - name: birth_date
        description: Candidate's date of birth

      - name: state
        description: U.S. state for the candidate

      - name: email
        description: Candidate's email address

      - name: phone_number
        description: Candidate's phone number

      - name: street_address
        description: Candidate's street address

      - name: website_url
        description: Candidate's campaign website

      - name: linkedin_url
        description: Candidate's LinkedIn profile URL

      - name: twitter_handle
        description: Candidate's Twitter handle

      - name: facebook_url
        description: Candidate's Facebook page URL

      - name: instagram_handle
        description: Candidate's Instagram handle

      - name: created_at
        description: Timestamp when the record was created
        data_tests:
          - not_null

      - name: updated_at
        description: Timestamp when the record was last updated
        data_tests:
          - not_null

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "updated_at >= created_at"
          config:
            where: "updated_at is not null and created_at is not null"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "(first_name is not null) or (last_name is not null) or (full_name is not null)"
          config:
            error_if: ">10"
            warn_if: ">0"

  - name: candidacy_stage
    description: >
      Historical archive of candidacy stages (primary, general, runoff results) from the general mart
      with election stages on or before 2025-12-31.

      Grain: One row per candidacy stage (candidacy + election stage combination).

    columns:
      - name: gp_candidacy_stage_id
        description: Primary key - internally generated unique identifier for candidacy stages
        data_tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$

      - name: gp_candidacy_id
        description: Foreign key to candidacy table
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('candidacy')
                field: gp_candidacy_id

      - name: gp_election_stage_id
        description: Foreign key to election_stage table
        data_tests:
          - relationships:
              arguments:
                to: ref('election_stage')
                field: gp_election_stage_id
              config:
                where: "gp_election_stage_id is not null"

      - name: ddhq_candidate
        description: Candidate name from DDHQ match

      - name: ddhq_candidate_id
        description: DDHQ candidate identifier

      - name: ddhq_race_id
        description: DDHQ race identifier

      - name: ddhq_candidate_party
        description: Candidate party from DDHQ

      - name: ddhq_is_winner
        description: Whether the candidate won the election stage

      - name: ddhq_llm_confidence
        description: LLM confidence score for the DDHQ match

      - name: ddhq_llm_reasoning
        description: LLM reasoning for the DDHQ match

      - name: ddhq_top_10_candidates
        description: Top 10 candidate matches from LLM

      - name: ddhq_has_match
        description: Whether a DDHQ match was found

      - name: votes_received
        description: Number of votes received in this election stage (may contain string values like 'uncontested')

      - name: ddhq_election_stage_date
        description: Date of the election stage
        data_tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: "'1900-01-01'"
                max_value: "'2025-12-31'"
              config:
                where: "ddhq_election_stage_date is not null"

      - name: created_at
        description: Timestamp when the record was created
        data_tests:
          - not_null

      - name: updated_at
        description: Timestamp when the record was last updated
        data_tests:
          - not_null

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "updated_at >= created_at"
          config:
            where: "updated_at is not null and created_at is not null"

  - name: election
    description: >
      Historical archive of elections from the general mart with election dates on or before 2025-12-31.

      Grain: One row per election.

    columns:
      - name: gp_election_id
        description: Primary key - internally generated unique identifier for elections
        data_tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$

      - name: official_office_name
        description: Formal office title for the election

      - name: candidate_office
        description: Simplified/standardized office name

      - name: office_level
        description: Level of office (local, state, federal)

      - name: office_type
        description: Type of office (executive, legislative, judicial, etc.)

      - name: state
        description: U.S. state for the election

      - name: city
        description: City for the election

      - name: district
        description: Electoral district

      - name: seat_name
        description: Specific seat name

      - name: election_date
        description: Date of the election
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: "'1900-01-01'"
                max_value: "'2025-12-31'"

      - name: election_year
        description: Year of the election
        data_tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1900
                max_value: 2025
              config:
                where: "election_year is not null"

      - name: filing_deadline
        description: Filing deadline for the election

      - name: population
        description: Population of the electoral district
        data_tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
              config:
                where: "population is not null"

      - name: seats_available
        description: Number of seats available in the election

      - name: term_start_date
        description: Start date of the term

      - name: is_uncontested
        description: Whether the election is uncontested

      - name: number_of_opponents
        description: Number of opponents in the race (may contain string values like '10+')

      - name: open_seat
        description: Whether the election is for an open seat

      - name: has_ddhq_match
        description: Whether there is a DDHQ match for this election

      - name: created_at
        description: Timestamp when the record was created
        data_tests:
          - not_null

      - name: updated_at
        description: Timestamp when the record was last updated
        data_tests:
          - not_null

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "updated_at >= created_at"
          config:
            where: "updated_at is not null and created_at is not null"

  - name: election_stage
    description: >
      Historical archive of election stages (primary, general, runoff) from the general mart
      with election stage dates on or before 2025-12-31.

      Grain: One row per election stage.

    columns:
      - name: gp_election_stage_id
        description: Primary key - internally generated unique identifier for election stages
        data_tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$

      - name: gp_election_id
        description: Foreign key to election table
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('election')
                field: gp_election_id

      - name: hubspot_contact_id
        description: Contact ID from HubSpot CRM

      - name: ddhq_race_id
        description: DDHQ race identifier
        data_tests:
          - not_null

      - name: election_stage
        description: Type of election stage (primary, general, runoff)

      - name: ddhq_election_stage_date
        description: Date of the election stage
        data_tests:
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: "'1900-01-01'"
                max_value: "'2025-12-31'"
              config:
                where: "ddhq_election_stage_date is not null"

      - name: ddhq_race_name
        description: Race name from DDHQ

      - name: total_votes_cast
        description: Total votes cast in the election stage (may contain string values like 'uncontested')

      - name: _airbyte_extracted_at
        description: Timestamp when the record was extracted from Airbyte
        data_tests:
          - not_null
