version: 2

models:
  - name: analytics_users
    description: >
      Unified user-grain view for Win and Serve product OKR metrics tracking.
      Built incrementally as new metrics are added.

      File is named analytics_users to avoid dbt model name collision with
      mart_civics.users.

      Grain: One row per user.

      Source: mart_civics.users (Gold tier) + Amplitude milestones.

    columns:
      - name: user_id
        description: Primary key â€” unique user identifier from mart_civics.users.
        data_tests:
          - unique
          - not_null

      - name: email
        description: User's email address.

      - name: first_name
        description: User's first name.

      - name: last_name
        description: User's last name.

      - name: phone
        description: User's phone number.

      - name: zip
        description: User's zip code.

      - name: is_win_user
        description: >
          Whether user is a Win product user (has created at least one campaign).
          Source: mart_civics.users.has_campaign
        data_tests:
          - not_null

      - name: is_serve_user
        description: >
          Whether user is a Serve product user (has completed a poll through
          an elected office). Source: mart_civics.users.is_serve_user
        data_tests:
          - not_null

      - name: eo_activated_at
        description: >
          Timestamp when user became a Serve user (first completed poll).
          NULL for non-Serve users.

      - name: campaign_count
        description: Total number of campaigns created by this user.

      - name: non_demo_campaign_count
        description: Number of non-demo campaigns.

      - name: verified_campaign_count
        description: Number of verified campaigns.

      - name: active_campaign_count
        description: Number of active campaigns.

      - name: pro_campaign_count
        description: Number of pro-tier campaigns.

      - name: pledged_campaign_count
        description: Number of campaigns where candidate took the GoodParty pledge.

      - name: first_campaign_created_at
        description: Timestamp of user's first campaign creation.

      - name: last_campaign_created_at
        description: Timestamp of user's most recent campaign creation.

      - name: has_verified_campaign
        description: Whether user has at least one verified campaign.

      - name: has_pledged_campaign
        description: Whether user has at least one pledged campaign.

      - name: is_pro
        description: >
          Whether user has upgraded at least one campaign to Pro tier.
          Source: mart_civics.users.pro_campaign_count > 0.
          Pro CVR = count(is_pro = true) / count(*) for a given registration cohort.
        data_tests:
          - not_null

      - name: amplitude_registration_completed_at
        description: >
          Earliest Amplitude timestamp for event
          'Onboarding - Registration Completed'. Primary denominator timestamp
          for onboarding conversion.

      - name: first_dashboard_viewed_at
        description: >
          Earliest Amplitude timestamp for event
          'Dashboard - Candidate Dashboard Viewed'. Primary numerator timestamp
          for onboarding conversion.

      - name: registration_country
        description: >
          Amplitude country value from the registration event
          ('Onboarding - Registration Completed'). Exposed for ad-hoc country
          slicing and used in is_onboarded logic.

      - name: is_onboarded
        description: >
          TRUE if US user viewed candidate dashboard within 14 days of Amplitude
          registration. Matches Bryan Levine's Exec Dashboard KPI exactly
          (US filter + 14-day window baked in). Filter to
          is_post_amplitude_registration = TRUE for clean denominators.
        data_tests:
          - not_null

      - name: onboarding_completed_at
        description: >
          Earliest Amplitude timestamp for event 'onboarding_complete'.
          Supplemental onboarding milestone from the OKR doc alternative definition.

      - name: has_completed_onboarding_flow
        description: >
          TRUE if onboarding_completed_at is present. Supplemental onboarding flag
          (no US segment filter and no 14-day window constraint).
        data_tests:
          - not_null

      - name: has_amplitude_data
        description: >
          TRUE if user has a matching registration-scoped record in
          int__amplitude_user_milestones (currently requires
          'Onboarding - Registration Completed'). Coverage indicator for
          Amplitude-backed metrics.
        data_tests:
          - not_null

      - name: is_post_amplitude_registration
        description: >
          TRUE if user registered on or after 2023-12-10 (Amplitude tracking start).
          REQUIRED filter for Amplitude-based CVR metrics.
        data_tests:
          - not_null

      - name: first_campaign_sent_at
        description: >
          Timestamp of user's first 'Voter Outreach - Campaign Completed' event.
          NULL if user has never sent a campaign.

      - name: is_activated
        description: >
          TRUE if user has completed at least one voter outreach campaign.
          This is the OKR "Activated Candidates" metric.
        data_tests:
          - not_null

      - name: total_campaigns_sent
        description: >
          Count of 'Voter Outreach - Campaign Completed' events for this user.
          Note: may undercount if Airbyte sync is in progress during dbt run.

      - name: registered_at
        description: >
          Timestamp when user account was created (signup date).
          Source: mart_civics.users.created_at
        data_tests:
          - not_null

      - name: registration_month
        description: Month truncation of registered_at for monthly counts.

      - name: registration_week
        description: Week truncation of registered_at for weekly counts.

      - name: registration_year
        description: Year of registration for annual grouping.

      - name: registration_quarter
        description: Quarter of registration (1-4) for quarterly OKR reporting.
    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "registration_country = 'United States'"
          config:
            where: "is_onboarded = true"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "has_amplitude_data = true"
          config:
            where: "is_onboarded = true"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "amplitude_registration_completed_at is not null"
          config:
            where: "has_amplitude_data = true"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "first_campaign_sent_at is not null"
          config:
            where: "is_activated = true"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "total_campaigns_sent > 0"
          config:
            where: "is_activated = true"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "is_activated = true"
          config:
            where: "first_campaign_sent_at is not null"
