version: 2

models:
  - name: int__techspeed_uploaded_files
    description: |
      Tracking table for TechSpeed source files that have been successfully processed.
      This replaces manual tracking in sandbox.uploaded_files for dbt-managed processing.
    columns:
      - name: source_file_url
        description: The _ab_source_file_url from TechSpeed source data
        tests:
          - not_null
          - unique
      - name: uploaded_at
        description: Timestamp when the file was successfully processed
        tests:
          - not_null
      - name: processing_date
        description: Date when the file was processed (for partitioning/filtering)
        tests:
          - not_null

  - name: int__techspeed_new_candidates
    description: |
      TechSpeed candidates from files that haven't been processed yet.
      This is an incremental model that only processes new source files.
    columns:
      - name: candidate_id_source
        description: Original candidate ID from TechSpeed
        tests:
          - not_null
          - unique
      - name: _ab_source_file_url
        description: Source file URL for tracking processed files
        tests:
          - not_null
      - name: new_records
        description: Flag indicating whether this record is from a new file (always 'new' in this model)

  - name: int__techspeed_cleaned_candidates
    description: |
      TechSpeed candidates with cleaned names, standardized fields, and contact validation.
      Applies complex name cleaning logic and filters out non-contactable candidates.
    columns:
      - name: last_name
        description: Cleaned last name using candidate_name_cleaning macro
      - name: phone
        description: Phone number with separators removed
      - name: candidate_type
        description: Standardized candidate type (Incumbent/Challenger)
      - name: election_type
        description: Standardized election type (Primary/General)
      - name: upload_exclusion_reason
        description: Reason for excluding from upload (e.g., 'no_contact')

  - name: int__techspeed_deduplicated_candidates
    description: |
      TechSpeed candidates after deduplication against existing HubSpot contacts.
      Excludes candidates already in HubSpot and applies date/business logic filters.
    columns:
      - name: ts_candidate_code
        description: Generated candidate code for deduplication (first_name__last_name__state__office_type)
      - name: standardized_office_type
        description: Office type standardized using map_ballotready_office_type macro
      - name: election_date
        description: Consolidated election date (General if available, else Primary)
      - name: corrected_general_election_date
        description: General election date with known corrections applied
      - name: final_exclusion_reason
        description: Final reason for excluding from upload (in_hubspot, past_election, etc.)

  - name: int__techspeed_candidates_processed
    description: |
      Complete processed TechSpeed candidate data with historical tracking and standardized formatting.
      This is the main storage table containing all transformations, validations, and business logic.
      Maintains historical records with proper timestamp management for audit trail.
    columns:
      - name: candidate_uuid
        description: Generated UUID based on candidate components (name, state, office, election year)
        tests:
          - not_null
          - unique
      - name: candidate_id_source
        description: Original candidate ID from TechSpeed
        tests:
          - not_null
      - name: first_name
        description: Candidate first name
        tests:
          - not_null
      - name: last_name
        description: Cleaned candidate last name using standardization macro
        tests:
          - not_null
      - name: email
        description: Candidate email address
      - name: phone
        description: Cleaned phone number (separators removed)
      - name: birth_date
        description: Birth date standardized to yyyy-mm-dd format
      - name: postal_code
        description: Cleaned 5-digit ZIP code (removes ZIP+4, leading dashes, zero-pads)
      - name: population
        description: Population as bigint (commas removed from string values)
      - name: filing_deadline
        description: Filing deadline standardized to yyyy-mm-dd format
      - name: primary_election_date
        description: Primary election date standardized to yyyy-mm-dd format
      - name: corrected_general_election_date
        description: General election date with corrections, standardized to yyyy-mm-dd format
      - name: election_date
        description: Consolidated election date standardized to yyyy-mm-dd format
      - name: standardized_office_type
        description: Office type standardized using map_ballotready_office_type macro
      - name: ts_candidate_code
        description: Generated candidate code for deduplication (first_name__last_name__state__office_type)
      - name: final_exclusion_reason
        description: Final reason for excluding from upload (no_first_name, no_last_name, no_contact, in_hubspot, past_election)
      - name: created_at
        description: Timestamp when candidacy record was first created
        tests:
          - not_null
      - name: updated_at
        description: Timestamp when candidacy record was last updated
        tests:
          - not_null
      - name: uploaded_at
        description: Timestamp when candidacy was last exported to HubSpot (NULL if never exported)
      - name: _ab_source_file_url
        description: Source file URL for tracking and audit purposes
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - candidate_uuid
            - updated_at

  - name: int__techspeed_hubspot_ready
    description: |
      Final TechSpeed candidates formatted for HubSpot export with recently updated records only.
      Simple view that renames columns to HubSpot format (spaced names) and filters to
      candidates updated within the last 30 days. Preserves nulls for data integrity.
    columns:
      - name: Candidate ID Source
        description: TechSpeed candidate identifier
      - name: First Name
        description: Candidate first name
      - name: Last Name
        description: Cleaned candidate last name
      - name: Email
        description: Candidate email address
      - name: Phone Number
        description: Cleaned phone number
      - name: Postal Code
        description: Zero-padded 5-digit postal code
      - name: Office Type
        description: Standardized office type for HubSpot
      - name: Election Date
        description: Primary election date (General if available, else Primary)
      - name: created_at
        description: Timestamp when candidacy record was first created (snake_case format)
      - name: updated_at
        description: Timestamp when candidacy record was last updated (snake_case format)
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - 'Candidate ID Source'
