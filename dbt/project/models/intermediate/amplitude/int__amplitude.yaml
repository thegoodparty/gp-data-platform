version: 2

models:
  - name: int__amplitude_user_milestones
    description: >
      User-grain intermediate model that aggregates milestone events from
      stg_airbyte_source__amplitude_api_events into one row per user_id for
      analytics.users metrics. Supports v0.3 (Onboarding CVR), v0.4 (Activated),
      and v0.5 (Active Candidates) from a single Amplitude scan.
    columns:
      - name: user_id
        description: >
          BIGINT user identifier parsed from Amplitude user_id (STRING).
          Primary key for this model; used to join to mart_civics.users.
        data_tests:
          - unique
          - not_null
          - relationships:
              arguments:
                to: ref('goodparty_data_catalog', 'users')
                field: user_id
              config:
                severity: warn

      - name: amplitude_registration_completed_at
        description: >
          Earliest timestamp for event_type = 'Onboarding - Registration Completed'.
          Denominator timestamp for v0.3 onboarding conversion.

      - name: first_dashboard_viewed_at
        description: >
          Earliest timestamp for event_type = 'Dashboard - Candidate Dashboard Viewed'.
          Numerator timestamp for v0.3 onboarding conversion.

      - name: registration_country
        description: >
          Amplitude country value from the registration event
          ('Onboarding - Registration Completed'). Used for US-segment filtering
          in v0.3 onboarding CVR.

      - name: onboarding_completed_at
        description: >
          Earliest timestamp for event_type = 'onboarding_complete'.
          Supplemental v0.3 column for OKR-document alternative onboarding definition.

      - name: first_campaign_sent_at
        description: >
          Earliest timestamp for event_type = 'Voter Outreach - Campaign Completed'.
          Supports v0.4 activation milestones.

      - name: total_campaigns_sent
        description: >
          Count of event_type = 'Voter Outreach - Campaign Completed' per user.
          Supports v0.4 campaign activity metrics.
        data_tests:
          - not_null

      - name: total_recipient_count
        description: >
          Sum of outreach recipient counts for
          event_type = 'Voter Outreach - Campaign Completed' per user.
          Uses COALESCE(recipientCount, voterContacts) and excludes values
          above 100000 or below 0 as Amplitude instrumentation errors.
        data_tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0

      - name: last_dashboard_viewed_at
        description: >
          Latest timestamp for event_type = 'Dashboard - Candidate Dashboard Viewed'.
          Supports v0.5 active-candidate recency logic.

      - name: dashboard_view_count
        description: >
          Count of event_type = 'Dashboard - Candidate Dashboard Viewed' per user.
          Supports v0.5 active-candidate usage intensity logic.
        data_tests:
          - not_null

      - name: pro_upgrade_completed_at
        description: >
          Earliest timestamp for event_type = 'pro_upgrade_complete'.
          Supplemental milestone for future analyses.

      - name: first_sms_poll_sent_at
        description: >
          Earliest timestamp for event_type = 'Serve Onboarding - SMS Poll Sent'.
          Supplemental Serve milestone for future analyses.
    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "first_dashboard_viewed_at <= last_dashboard_viewed_at"
          config:
            where: "first_dashboard_viewed_at is not null and last_dashboard_viewed_at is not null"

  - name: int__amplitude_serve_activity
    description: >
      User x month intermediate aggregating Serve MAU activity from Amplitude.
      Filters to canonical Serve MAU definition (AD-04): Viewed event on
      /dashboard/polls with Serve Activated = true, excluding @goodparty.org.

      Grain: One row per user_id x activity_month.

      Source: stg_airbyte_source__amplitude_api_events.
    columns:
      - name: user_id
        description: User identifier (BIGINT, cast from Amplitude string user_id).
        data_tests:
          - not_null

      - name: activity_month
        description: Calendar month of activity (first day of month).
        data_tests:
          - not_null

      - name: email
        description: User email from Amplitude user_properties. Used for internal exclusion.

      - name: first_activity_at
        description: Earliest poll dashboard view in this month.
        data_tests:
          - not_null

      - name: last_activity_at
        description: Latest poll dashboard view in this month.
        data_tests:
          - not_null

      - name: poll_view_count
        description: Total poll dashboard views in this month.
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1

      - name: activity_days
        description: Distinct days with poll dashboard views in this month.
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - user_id
              - activity_month
      - dbt_utils.expression_is_true:
          arguments:
            expression: "activity_days <= day(last_day(activity_month))"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "poll_view_count >= activity_days"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "last_activity_at >= first_activity_at"
