version: 2

models:
  - name: int__gp_ai_candidacies
    description: >
      Intermediate model that creates the candidacies object in the intermediate layer using the HubSpot data.
      A "candidacy" is a combination of a candidate and a full election for a specific office in a specific year.
      This is the format used to start the election match process for GP AI.
    columns:
      - name: gp_candidacy_id
        description: Unique identifier for the candidacy in the HubSpot data. Can have multiple matches for the same candidacy in different races.
        data_tests:
          - not_null
          - unique
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      - name: created_at
        description: Timestamp when the record was first created
        data_tests:
          - not_null
      - name: updated_at
        description: Timestamp when the record was last updated
        data_tests:
          - not_null
    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "updated_at >= created_at"
            config:
              where: "updated_at is not null and created_at is not null"

  - name: int__gp_ai_start_election_match
    description: Intermediate model that starts the election match process for GP AI
    config:
      dbt_environment: "{{ env_var('DBT_ENVIRONMENT') }}"
      gp_ai_url: "{{ env_var('DBT_GP_AI_URL') }}"
    columns:
      - name: run_id
        description: Unique identifier for the election match process
        tests:
          - not_null
          - unique
      - name: s3_output.files.parquet
        description: S3 path to the parquet output file
        tests:
          - not_null

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "regexp_like(run_id, '^[0-9]{8}_[0-9]{6}$')"

  - name: int__gp_ai_election_match
    description: Intermediate model that fetches and loads the parquet output file from the int__gp_ai_start_election_match model. This model reads the election match results from S3 and loads them into the data warehouse.
    columns:
      - name: gp_candidacy_id
        description: Unique identifier for the candidacy in the HubSpot data. Can have multiple matches for the same candidacy in different races.
        data_tests:
          - not_null
      - name: run_id
        description: Unique identifier for the election match process run, linking back to int__gp_ai_start_election_match
        data_tests:
          - not_null
      - name: ddhq_race_id
        description: Unique identifier for the race in the DDHQ data. Can have multiple matches for the same candidacy in different races.
        data_tests:
          - not_null:
              config:
                where: "has_match is true"
      - name: ddhq_candidate_id
        description: Unique identifier for the candidate in the DDHQ data. Can have multiple matches for the same candidacy in different races.
        data_tests:
          - not_null:
              config:
                where: "has_match is true"
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - gp_candidacy_id
              - election_date
              - election_type
