version: 2

models:
  - name: int__l2_district_aggregations
    description: "District aggregations with voter counts per district (state, district type, and district name)"
    columns:
  - name: int__l2_district_aggregations
    description: Intermediate model that aggregates L2 district data for downstream use.
    columns:
      - name: id
        description: Internally generated unique identifier for the district aggregation.
        tests:
          - not_null
          - unique
          - dbt_expectations.expect_column_values_to_match_regex:
              arguments:
                regex: ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      - name: state_postal_code
        description: "Uppercase two-letter state postal code"
        tests:
          - not_null
          - dbt_expectations.expect_column_distinct_values_to_equal_set:
              arguments:
                value_set: "{{ get_us_states_list(include_DC=true, include_US=false) }}"
      - name: district_type
        description: "Type of district (e.g., US_Congressional_District, State_Senate_District)"
        tests:
          - not_null
      - name: district_name
        description: "The actual district identifier/name"
        tests:
          - not_null
      - name: voter_count
        description: "Number of distinct voters in this district"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              arguments:
                column_type: BIGINT
      - name: loaded_at
        description: "Timestamp from the source L2 uniform data"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - state_postal_code
              - district_type
              - district_name

  - name: int__l2_nationwide_uniform
    description: "Combined uniform voter file data from all states"
    columns:
      - name: state_postal_code
        description: "Uppercase two-letter state postal code"
        tests:
          - dbt_expectations.expect_column_distinct_values_to_equal_set:
              arguments:
                value_set: "{{ get_us_states_list(include_DC=true, include_US=false) }}"

  - name: int__l2_nationwide_haystaq_flags
    description: "Combined Haystaq issue model flags from all states (loaded from per-state L2 Haystaq flags tables)"
    config:
      dbt_environment: "{{ env_var('DBT_ENVIRONMENT') }}"
      # optional: comma/space-separated list like \"AK,AL\" for iterative runs
      l2_state_allowlist: "{{ var('l2_state_allowlist', '') }}"
      # optional override if your user doesn't have permissions on the default source schema
      l2_haystaq_databricks_schema: "{{ var('l2_haystaq_databricks_schema', '') }}"
    columns:
      - name: LALVOTERID
        description: "The ID of the voter"
        tests:
          - not_null
          - unique

  - name: int__l2_nationwide_haystaq_scores
    description: "Combined Haystaq issue model scores from all states (loaded from per-state L2 Haystaq scores tables)"
    config:
      dbt_environment: "{{ env_var('DBT_ENVIRONMENT') }}"
      # optional: comma/space-separated list like \"AK,AL\" for iterative runs
      l2_state_allowlist: "{{ var('l2_state_allowlist', '') }}"
      # optional override if your user doesn't have permissions on the default source schema
      l2_haystaq_databricks_schema: "{{ var('l2_haystaq_databricks_schema', '') }}"
    columns:
      - name: LALVOTERID
        description: "The ID of the voter"
        tests:
          - not_null
          - unique

  - name: int__l2_nationwide_uniform_w_haystaq
    description: "Nationwide uniform voter file data with Haystaq flags and scores joined on LALVOTERID"
    config:
      dbt_environment: "{{ env_var('DBT_ENVIRONMENT') }}"
      # optional: comma/space-separated list like \"AK,AL\" for iterative runs
      l2_state_allowlist: "{{ var('l2_state_allowlist', '') }}"
    columns:
      - name: state_postal_code
        description: "Uppercase two-letter state postal code"
        tests:
          - dbt_expectations.expect_column_distinct_values_to_equal_set:
              arguments:
                value_set: "{{ get_us_states_list(include_DC=true, include_US=false) }}"
      - name: haystaq_flags_loaded_at
        description: "loaded_at from Haystaq flags source (per-state DNA flags tables)"
      - name: haystaq_scores_loaded_at
        description: "loaded_at from Haystaq scores source (per-state DNA scores tables)"

  - name: int__zip_code_to_br_office
    description: "Zip code to BR office mapping"
    columns:
      - name: zip_code
        description: "Zip code"
        tests:
          - not_null
      - name: state_postal_code
        description: "State postal code"
        tests:
          - dbt_expectations.expect_column_distinct_values_to_equal_set:
              arguments:
                value_set: "{{ get_us_states_list(include_DC=true, include_US=false) }}"
      - name: district_type
        description: "District type"
        tests:
          - not_null
      - name: district_name
        description: "District name"
        tests:
          - not_null
      - name: confidence
        description: "LLM confidence"
      - name: br_database_id
        description: "BallotReady/CivicEngine database ID"
        tests:
          - relationships:
              arguments:
                to: ref("stg_airbyte_source__ballotready_api_position")
                field: database_id
      - name: br_position_id
        description: "BallotReady/CivicEngine position ID"
        tests:
          - relationships:
              arguments:
                to: ref("stg_airbyte_source__ballotready_api_position")
                field: id
      - name: br_race_id
        description: "BR race ID"
        tests:
          - relationships:
              arguments:
                to: ref("stg_airbyte_source__ballotready_api_race")
                field: id
      - name: br_race_database_id
        description: "BR race database ID"
        tests:
          - relationships:
              arguments:
                to: ref("stg_airbyte_source__ballotready_api_race")
                field: database_id
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - zip_code
              - district_type
              - district_name
              - br_race_database_id

  - name: int__zip_code_to_l2_district
    description: "Zip code to L2 district mapping"
    columns:
      - name: zip_code
        description: "Zip code"
        tests:
          - not_null
      - name: state_postal_code
        description: "State postal code"
        tests:
          - dbt_expectations.expect_column_distinct_values_to_equal_set:
              arguments:
                value_set: "{{ get_us_states_list(include_DC=true, include_US=false) }}"
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - zip_code
              - state_postal_code
              - district_type
